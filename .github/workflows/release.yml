name: Luxoria Desktop App Release

on:
  push:
    branches:
      - main
      - develop
      - feat/unpackaged-version
      - release/*

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        configuration: [Release]
        platform: [x64, x86, arm64]

    env:
      Solution_Name: Luxoria.App.sln

    steps:
      # Checkout the code from the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up .NET SDK
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.x'  # Specify the .NET SDK version you are using
      
      # Add  MSBuild to the PATH: https://github.com/microsoft/setup-msbuild
      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v1.0.2
      
      # Restore the application to populate the obj folder with RuntimeIdentifiers
      - name: Restore the application
        run: msbuild $env:Solution_Name /t:Restore /p:Configuration=$env:Configuration
        env:
          Configuration: ${{ matrix.configuration }}
        working-directory: ./Luxoria.App

      # Define a custom publish directory
      - name: Set publish directory
        run: echo "PUBLISH_DIR=./Luxoria.App/PublishedOutput/${{ matrix.configuration }}/${{ matrix.platform }}/" >> $GITHUB_ENV

      # Create the app by building and publishing the project
      - name: Build Luxoria.App
        run: msbuild $env:Solution_Name /t:Publish /p:Configuration=$env:Configuration /p:Platform=$env:Platform
        env:
          Configuration: ${{ matrix.configuration }}
          Platform: ${{ matrix.platform }}
        working-directory: ./Luxoria.App

      # (debug) List the files in the publish folder
      - name: List the files in the publish folder
        run: ls -R ./Luxoria.App/Luxoria.App/bin

      # Upload the app as an artifact
      - name: Upload Luxoria.App as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: Luxoria.App.$env:Configuration.$env:Platform
          path: ./Luxoria.App/Luxoria.App/bin
      
      # Set a dynamic artifact name
      - name: Set artifact name
        run: echo "ARTIFACT_NAME=Luxoria.App.${{ matrix.configuration }}.${{ matrix.platform }}" >> $GITHUB_ENV

      # Upload the app as an artifact
      - name: Upload the app
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.PUBLISH_DIR }}
